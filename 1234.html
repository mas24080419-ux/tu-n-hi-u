<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tu·∫•n ƒê·ªì Hi·ªáu ‚Äî Th·ªùi trang h√†ng hi·ªáu</title>
  <meta name="description" content="Tu·∫•n ƒê·ªì Hi·ªáu - Th·ªùi trang cao c·∫•p" />
  <!-- Font h·ªó tr·ª£ ti·∫øng Vi·ªát -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans:wght@400;700&display=swap" rel="stylesheet">
  <!-- html2pdf ƒë·ªÉ t·∫°o PDF h√≥a ƒë∆°n -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  <!-- EmailJS (t√πy ch·ªçn, ch·ªâ d√πng khi b·∫°n c·∫•u h√¨nh) -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

  <style>
    :root{
      --accent:#f39c12;
      --dark:#111;
      --muted:#6b6b6b;
      --bg:#fbfbfb;
      --card:#fff;
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;font-family:'Noto Sans',system-ui,Segoe UI,Roboto,Arial;
      background:var(--bg);color:var(--dark);-webkit-font-smoothing:antialiased;
      line-height:1.45;
    }

    /* Header */
    header{
      position:sticky;top:0;z-index:1200;background:#fff;border-bottom:1px solid #eee;
      padding:12px 18px;
    }
    .header-inner{max-width:1200px;margin:0 auto;display:flex;align-items:center;gap:12px}
    .brand{font-weight:800;color:var(--accent);font-size:18px}
    nav{display:flex;gap:12px;align-items:center;margin-left:8px}
    nav a{color:#222;text-decoration:none;font-weight:600}
    .search-wrap{margin-left:auto;display:flex;align-items:center;gap:10px}
    .search-wrap input{padding:8px 12px;border-radius:999px;border:1px solid #eee;width:320px}
    .cart-toggle{background:transparent;border:0;cursor:pointer;font-weight:800;position:relative;padding:6px 10px}
    .cart-count{position:absolute;top:-8px;right:-6px;background:#d9534f;color:#fff;padding:4px 7px;border-radius:999px;font-size:12px;font-weight:800}

    /* Layout */
    .wrap{max-width:1200px;margin:26px auto;padding:0 18px;display:grid;grid-template-columns:260px 1fr;gap:20px}
    @media (max-width:920px){ .wrap{grid-template-columns:1fr;padding:0 12px} }

    aside.panel{
      background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 24px rgba(0,0,0,0.04);
      position:sticky;top:78px;align-self:start;
    }
    .panel h3{margin:0 0 12px;color:var(--accent);font-size:16px}
    .filter-group{margin-bottom:14px}
    .brand-list{display:flex;flex-direction:column;gap:8px}
    .brand-btn{padding:8px 10px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer;text-align:left}
    .brand-btn.active{border-color:var(--accent);box-shadow:0 8px 24px rgba(243,156,18,0.06);color:var(--accent);font-weight:700}

    label.price-chip{display:flex;align-items:center;gap:8px;padding:8px;border-radius:8px;border:1px solid #eee;background:#fff;cursor:pointer;margin-bottom:8px}

    .clear-filters{background:transparent;border:1px dashed #ccc;padding:8px;border-radius:8px;cursor:pointer;color:var(--muted)}

    /* Products */
    .section-title{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:18px}
    .card{background:var(--card);border-radius:12px;overflow:hidden;box-shadow:0 12px 36px rgba(17,17,17,0.04);transition:transform .22s;display:flex;flex-direction:column}
    .card:hover{transform:translateY(-8px)}
    .card img{width:100%;height:240px;object-fit:cover}
    .meta{padding:12px;display:flex;flex-direction:column;flex:1}
    .meta h4{margin:0 0 6px}
    .meta p{margin:0;color:var(--muted);font-size:13px;flex:1}
    .foot{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:12px}
    .price{color:var(--accent);font-weight:900}

    .btn{padding:9px 14px;border-radius:8px;border:0;cursor:pointer;font-weight:700}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:#f3f3f3}

    /* Cart Sidebar (beautiful title) */
    .cart-sidebar{
      position:fixed;top:0;right:-430px;width:420px;height:100vh;background:#fff;
      box-shadow:-24px 0 60px rgba(0,0,0,0.12);transition:right .34s cubic-bezier(.22,.9,.4,1);
      z-index:1400;display:flex;flex-direction:column;
    }
    .cart-sidebar.open{right:0}
    .cart-head{
      padding:22px 20px;border-bottom:1px solid #f1f1f1;text-align:center;
    }
    .cart-head h2{margin:0;font-size:20px;letter-spacing:0.4px}
    .cart-head .sub{color:var(--muted);font-size:13px;margin-top:6px}

    .cart-body{flex:1;overflow:auto;padding:18px}
    .cart-item{display:flex;gap:12px;align-items:center;padding:10px 0;border-bottom:1px solid #f1f1f1}
    .cart-item img{width:72px;height:72px;object-fit:cover;border-radius:8px}
    .cart-item .info{flex:1}
    .cart-item .info h4{margin:0;font-size:15px}
    .cart-item .info .meta{color:var(--muted);font-size:13px;margin-top:6px}
    .qty-controls{display:flex;gap:8px;margin-top:8px}
    .qty-controls button{width:32px;height:32px;border-radius:8px;border:0;background:#f3f3f3;cursor:pointer}

    .cart-foot{padding:18px;border-top:1px solid #f1f1f1}
    .cart-foot .row{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .cart-foot .total{font-weight:900;font-size:18px}
    .cart-foot .email-box{display:flex;gap:8px;margin-top:8px}
    .cart-foot input[type="email"]{flex:1;padding:10px;border-radius:8px;border:1px solid #eee}

    /* Payment tabs inside cart */
    .pm-tabs{display:flex;gap:8px;margin-top:12px}
    .pm-tab{flex:1;padding:8px;border-radius:8px;border:1px solid #eee;background:#fafafa;text-align:center;cursor:pointer}
    .pm-tab.active{background:var(--accent);color:#fff;border:none}

    .pm-box{margin-top:12px;display:none;text-align:center}
    .pm-box.active{display:block}
    .pm-box img{width:200px;height:200px;object-fit:cover;border-radius:10px;box-shadow:0 18px 40px rgba(0,0,0,0.06)}
    .pm-info{font-size:14px;color:var(--muted);margin-top:10px}

    .cart-actions{display:flex;gap:8px;margin-top:12px}
    .cart-actions .btn{flex:1}

    .contact-note{margin-top:12px;font-size:13px;color:var(--muted);text-align:center}

    /* detail modal */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,0.5);display:none;align-items:center;justify-content:center;padding:18px;z-index:1600}
    .modal.open{display:flex}
    .dialog{background:#fff;border-radius:12px;max-width:980px;width:100%;max-height:92vh;overflow:auto;padding:18px;position:relative}
    .dialog .close{position:absolute;right:12px;top:12px;border:0;background:none;font-size:20px;cursor:pointer}
    .detail-grid{display:grid;grid-template-columns:420px 1fr;gap:18px}
    @media (max-width:920px){ .detail-grid{grid-template-columns:1fr} .cart-sidebar{width:100%;} }

    /* invoice hidden container */
    .invoice{font-family:'Noto Sans',sans-serif;padding:20px;background:#fff;width:800px;max-width:800px}
    .inv-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    .inv-title{font-weight:800;color:var(--accent);font-size:20px}
    .inv-table{width:100%;border-collapse:collapse;margin-top:8px}
    .inv-table th,.inv-table td{border:1px solid #eee;padding:8px;text-align:left}
    footer{max-width:1200px;margin:36px auto;padding:18px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>

  <header>
    <div class="header-inner">
      <div class="brand">Tu·∫•n ƒê·ªì Hi·ªáu</div>
      <nav>
        <a href="#" onclick="scrollToProducts()">Trang ch·ªß</a>
        <a href="#products" onclick="scrollToProducts()">S·∫£n ph·∫©m</a>
        <a href="#contact" onclick="scrollToContact()">Li√™n h·ªá</a>
      </nav>

      <div class="search-wrap">
        <input id="globalSearch" placeholder="T√¨m s·∫£n ph·∫©m, v√≠ d·ª•: t√∫i, v√°y..." aria-label="T√¨m s·∫£n ph·∫©m">
        <button class="cart-toggle" onclick="toggleCart()">üõí <span id="miniCount" class="cart-count">0</span></button>
      </div>
    </div>
  </header>

  <!-- HERO -->
  <section style="max-width:1200px;margin:22px auto;padding:20px;border-radius:12px;background:linear-gradient(180deg,#fff,#fff);box-shadow:0 12px 40px rgba(0,0,0,0.04);text-align:center">
    <h1 style="margin:6px 0;font-size:28px">ƒê·∫≥ng c·∫•p th·ªùi trang ‚Äî Phong c√°ch ri√™ng</h1>
    <p style="color:var(--muted);margin-top:6px">Uy t√≠n t·∫°o n√™n th∆∞∆°ng hi·ªáu ¬∑ Mi·ªÖn ph√≠ giao h√†ng n·ªôi th√†nh cho ƒë∆°n h√†ng tr√™n 10 tri·ªáu</p>
  </section>

  <main class="wrap">
    <!-- LEFT FILTERS -->
    <aside class="panel" aria-label="B·ªô l·ªçc">
      <h3>B·ªô l·ªçc</h3>

      <div class="filter-group">
        <div style="font-weight:700;margin-bottom:8px">T√¨m ki·∫øm</div>
        <input id="filterSearch" placeholder="T√¨m trong b·ªô l·ªçc..." style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee">
      </div>

      <div class="filter-group">
        <div style="font-weight:700;margin-bottom:8px">Th∆∞∆°ng hi·ªáu</div>
        <div class="brand-list" id="brandList"></div>
      </div>

      <div class="filter-group">
        <div style="font-weight:700;margin-bottom:8px">Gi√°</div>
        <label class="price-chip"><input type="radio" name="price" value="all" checked onchange="applyFilters()"> T·∫•t c·∫£</label>
        <label class="price-chip"><input type="radio" name="price" value="0-10000000" onchange="applyFilters()"> D∆∞·ªõi 10 tri·ªáu</label>
        <label class="price-chip"><input type="radio" name="price" value="10000000-30000000" onchange="applyFilters()"> 10 - 30 tri·ªáu</label>
        <label class="price-chip"><input type="radio" name="price" value="30000000-999999999" onchange="applyFilters()"> Tr√™n 30 tri·ªáu</label>
      </div>

      <div style="display:flex;gap:8px;margin-top:14px">
        <button class="clear-filters" onclick="resetFilters()">X√≥a b·ªô l·ªçc</button>
        <button class="btn primary" style="flex:1" onclick="applyFilters()">√Åp d·ª•ng</button>
      </div>
    </aside>

    <!-- PRODUCTS -->
    <section id="products">
      <div class="section-title">
        <div>
          <h2 style="margin:0">S·∫£n ph·∫©m n·ªïi b·∫≠t</h2>
          <div id="resultsInfo" style="color:var(--muted);font-size:13px;margin-top:6px"></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center">
          <select id="sortBy" onchange="applyFilters()" style="padding:8px;border-radius:8px;border:1px solid #eee">
            <option value="default">S·∫Øp x·∫øp</option>
            <option value="price-asc">Gi√°: th·∫•p ‚Üí cao</option>
            <option value="price-desc">Gi√°: cao ‚Üí th·∫•p</option>
          </select>
        </div>
      </div>

      <div class="grid" id="productGrid" aria-live="polite"></div>
    </section>
  </main>

  <!-- CART SIDEBAR -->
  <aside class="cart-sidebar" id="cartSidebar" aria-hidden="true">
    <div class="cart-head">
      <h2>Gi·ªè h√†ng</h2>
      <div class="sub">Ki·ªÉm tra & Thanh to√°n</div>
    </div>

    <div class="cart-body">
      <ul id="cartList" style="list-style:none;padding:0;margin:0"></ul>

      <div style="margin-top:14px">
        <div style="font-weight:700;margin-bottom:8px">Ph∆∞∆°ng th·ª©c thanh to√°n</div>
        <div class="pm-tabs">
          <div class="pm-tab active" data-method="qr" onclick="switchPayTab(this)">QR Code</div>
          <div class="pm-tab" data-method="bank" onclick="switchPayTab(this)">Chuy·ªÉn kho·∫£n</div>
          <div class="pm-tab" data-method="cod" onclick="switchPayTab(this)">COD</div>
        </div>

        <div id="pm-qr" class="pm-box active">
          <img id="qrImg" src="1c1cdaee-438e-4e87-be70-20b166f17d17.jpeg" alt="QR thanh to√°n">
          <div class="pm-info">Qu√©t m√£ QR ƒë·ªÉ chuy·ªÉn kho·∫£n nhanh. Sau khi chuy·ªÉn, nh·∫•n "T√¥i ƒë√£ thanh to√°n" ƒë·ªÉ nh·∫≠n h√≥a ƒë∆°n.</div>
          <div style="margin-top:8px"><button class="btn primary" onclick="confirmPaid('qr')">T√¥i ƒë√£ thanh to√°n</button></div>
        </div>

        <div id="pm-bank" class="pm-box">
          <div class="pm-info">
            <div><strong>Ng√¢n h√†ng:</strong> Techcombank</div>
            <div><strong>S·ªë TK:</strong> 9999 9999 2006 8</div>
            <div><strong>Ch·ªß TK:</strong> NGO VAN TUAN ANH</div>
          </div>
          <div style="margin-top:8px"><button class="btn primary" onclick="confirmPaid('bank')">T√¥i ƒë√£ chuy·ªÉn kho·∫£n</button></div>
        </div>

        <div id="pm-cod" class="pm-box">
          <div class="pm-info">Thanh to√°n khi nh·∫≠n h√†ng. Nh√¢n vi√™n giao h√†ng s·∫Ω thu ti·ªÅn t·∫°i ƒë·ªãa ch·ªâ nh·∫≠n h√†ng.</div>
          <div style="margin-top:8px"><button class="btn primary" onclick="confirmPaid('cod')">X√°c nh·∫≠n ƒë·∫∑t h√†ng (COD)</button></div>
        </div>
      </div>
    </div>

    <div class="cart-foot">
      <div class="row"><div class="muted">T·ªïng</div><div class="total" id="cartTotal">0 ƒë</div></div>

      <div style="font-size:13px;color:var(--muted)">G·ª≠i h√≥a ƒë∆°n v·ªÅ email (b·∫Øt bu·ªôc n·∫øu mu·ªën nh·∫≠n h√≥a ƒë∆°n ƒëi·ªán t·ª≠):</div>
      <div class="cart-foot email-box" style="margin-top:8px">
        <input id="invoiceEmail" type="email" placeholder="email@khachhang.com">
        <button class="btn" onclick="downloadInvoice()">T·∫£i</button>
      </div>

      <div class="cart-actions">
        <button class="btn primary" onclick="openCheckoutFromCart()">Thanh to√°n</button>
        <button class="btn" onclick="clearCart()">X√≥a</button>
      </div>

      <div class="contact-note">Li√™n h·ªá: <strong>0945130494</strong> ‚Äî Email: <strong>tuananhperfume09@gmail.com</strong></div>
    </div>
  </aside>

  <!-- DETAIL MODAL -->
  <div id="detailModal" class="modal" aria-hidden="true">
    <div class="dialog" role="dialog" aria-modal="true">
      <button class="close" onclick="closeDetail()">‚úï</button>

      <div class="detail-grid">
        <div>
          <img id="detailMain" src="" alt="·∫£nh" style="width:100%;border-radius:10px;max-height:420px;object-fit:cover">
          <div id="thumbs" style="display:flex;gap:8px;margin-top:10px"></div>
        </div>

        <div>
          <h2 id="detailTitle"></h2>
          <div id="detailBrand" class="muted"></div>
          <div id="detailPrice" style="font-weight:900;color:var(--accent);margin-top:10px"></div>
          <p id="detailDesc" class="muted" style="margin-top:12px"></p>
          <h4 style="margin-top:12px">Chi ti·∫øt</h4>
          <p id="detailFeaturesText" class="muted"></p>
          <a href="#" id="detailMore" style="color:var(--accent);display:inline-block;margin-top:8px">Xem th√™m</a>

          <div style="margin-top:16px;display:flex;gap:12px">
            <button class="btn primary" id="detailAddBtn">Th√™m v√†o gi·ªè</button>
            <button class="btn" onclick="toggleCart(true)">Xem gi·ªè</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- checkout modal (simple) -->
  <div id="checkoutModal" class="modal" aria-hidden="true">
    <div class="dialog" style="max-width:720px">
      <button class="close" onclick="closeCheckout()">‚úï</button>
      <h2>Thanh to√°n</h2>
      <div id="checkoutSummary" style="margin-top:10px"></div>

      <div style="margin-top:12px">
        <label style="font-weight:700">Ch·ªçn ph∆∞∆°ng th·ª©c</label>
        <div style="display:flex;gap:10px;margin-top:8px">
          <label><input type="radio" name="checkoutPay" value="qr" checked> QR</label>
          <label><input type="radio" name="checkoutPay" value="bank"> Chuy·ªÉn kho·∫£n</label>
          <label><input type="radio" name="checkoutPay" value="cod"> COD</label>
        </div>
      </div>

      <div style="margin-top:12px">
        <label>Email ƒë·ªÉ nh·∫≠n h√≥a ƒë∆°n</label>
        <input id="checkoutEmail" type="email" placeholder="email@khachhang.com" style="width:100%;padding:10px;border-radius:8px;border:1px solid #eee;margin-top:6px">
      </div>

      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="btn primary" onclick="processCheckout()">X√°c nh·∫≠n & T·∫°o h√≥a ƒë∆°n</button>
        <button class="btn" onclick="closeCheckout()">H·ªßy</button>
      </div>

    </div>
  </div>

  <!-- hidden invoice container -->
  <div id="invoiceContainer" style="display:none"></div>

  <footer id="contact" style="margin-top:36px">
    <div style="max-width:1200px;margin:0 auto;padding:18px;text-align:center;color:var(--muted)">
      ¬© 2025 Tu·∫•n ƒê·ªì Hi·ªáu ‚Äî Louis Vuitton ‚Ä¢ Chanel ‚Ä¢ Gucci ‚Ä¢ Dior ‚Ä¢ Prada
      <div style="margin-top:8px">Li√™n h·ªá: <strong>0945130494</strong> ‚Äî Email: <strong>tuananhperfume09@gmail.com</strong></div>
    </div>
  </footer>

<script>
/* ------------------ DATA ------------------ */
const products = [
  { id:1, name:"Gi√†y LV Remix", desc:"Gi√†y l∆∞·ªùi LV Remix th·ªùi th∆∞·ª£ng.", price:34000000, brand:"Louis Vuitton", image:"https://vn.louisvuitton.com/images/is/image/lv/1/PP_VP_L/louis-vuitton-lv-remix-boat-shoe--BVZ002PC92_PM1_Worn%20view.png?wid=1090&hei=1090", gallery:["https://vn.louisvuitton.com/images/is/image/lv/1/PP_VP_L/louis-vuitton-lv-remix-boat-shoe--BVZ002PC92_PM2_Front%20view.png?wid=1090&hei=1090","https://vn.louisvuitton.com/images/is/image/lv/1/PP_VP_L/louis-vuitton-lv-remix-boat-shoe--BVZ002PC92_PM1_Cropped%20worn%20view.png?wid=1090&hei=1090"], features:["M√†u n√¢u","V·∫£i Monogram","ƒê·∫ø ngo√†i b·∫±ng cao su v·ªõi logo LV v√† hoa Monogram d∆∞·ªõi m·∫∑t rƒÉng c∆∞a","S·∫£n xu·∫•t t·∫°i √ù"] },
  { id:2, name:"T√∫i GG Marmont", desc:"T√∫i mini GG Marmont sang tr·ªçng.", price:52000000, brand:"Gucci", image:"https://sneakerdaily.vn/wp-content/uploads/2023/10/Giay-Adidas-Velosamba-Cloud-White-IE7022-40.jpg.webp", gallery:["https://sneakerdaily.vn/wp-content/uploads/2023/10/1-144.jpg.webp","https://sneakerdaily.vn/wp-content/uploads/2023/10/3-136.jpg.webp"], features:["Logo GG","Da m·ªÅm","D√¢y kim lo·∫°i cao c·∫•p"] },
  { id:3, name:"Prada Re-Edition 2005", desc:"T√∫i nylon Re-Edition c·ªï ƒëi·ªÉn.", price:32000000, brand:"Prada", image:"https://www.prada.com/content/dam/pradabkg_products/1/1BH/1BH204/R064F0002/1BH204_R064_F0002_V_V9L_SLF.jpg/_jcr_content/renditions/cq5dam.web.hebebed.2000.2000.jpg", gallery:["https://blankroom.co/cdn/shop/files/prada-re-edition-2005-re-nylon-and-saffiano-mini-bag-black-1NE204_R064_F0002-authentic-blankroom-viet-nam-c.jpg?v=1718943129&width=713"], features:["Nylon t√°i ch·∫ø","Phong c√°ch retro","Ph·ª• ki·ªán kim lo·∫°i"] },
  { id:4, name:"√Åo Polo Nam Dior Black With CD Logo Embroidered ", desc:"593J812A3025-980.", price:18000000, brand:"Dior", image:"https://cdn.vuahanghieu.com/unsafe/0x500/left/top/smart/filters:quality(90)/https://admin.vuahanghieu.com/upload/product/2025/07/ao-polo-nam-dior-black-with-cd-logo-embroidered-593j812a3025-980-mau-den-size-s-688b1ba809810-31072025143048.jpg", gallery:["https://assets.christiandior.com/is/image/diorprod/LOOK_H_25_2_LOOK_135_E07?$lookDefault_GH-GHC$&crop=568,0,1864,2000&wid=1024&hei=1107&scale=0.5535&bfc=on&qlt=85"], features:["Cotton cao c·∫•p","Form slimfit","Tho√°ng m√°t"] }
];

/* ------------------ STATE ------------------ */
let cart = JSON.parse(localStorage.getItem('tdh_cart') || '[]');
let filters = { brand:'all', price:'all', q:'' };
let sortBy = 'default';

/* ------------------ HELPERS ------------------ */
function formatMoney(n){ return n.toLocaleString('vi-VN') + ' ƒë'; }
function saveCart(){ localStorage.setItem('tdh_cart', JSON.stringify(cart)); }

/* ------------------ RENDER FILTERS ------------------ */
const brandSet = [...new Set(products.map(p=>p.brand))];
const brandListEl = document.getElementById('brandList');
brandSet.forEach(b=>{
  const btn = document.createElement('button');
  btn.className = 'brand-btn';
  btn.textContent = b;
  btn.onclick = ()=> { filters.brand = (filters.brand===b)?'all':b; updateBrandButtons(); applyFilters(); };
  brandListEl.appendChild(btn);
});
function updateBrandButtons(){
  document.querySelectorAll('.brand-btn').forEach(b=>{
    b.classList.toggle('active', filters.brand === b.textContent);
  });
}

/* -------------- PRODUCT RENDER -------------- */
const productGrid = document.getElementById('productGrid');
function getFilteredProducts(){
  const q = (document.getElementById('globalSearch').value || '').trim().toLowerCase();
  const q2 = (document.getElementById('filterSearch').value || '').trim().toLowerCase();
  let list = products.filter(p=>{
    if(filters.brand !== 'all' && p.brand !== filters.brand) return false;
    if(filters.price !== 'all'){
      const [min,max] = filters.price.split('-').map(Number);
      if(!(p.price >= min && p.price <= max)) return false;
    }
    if(q && !(p.name.toLowerCase().includes(q) || p.desc.toLowerCase().includes(q) || p.brand.toLowerCase().includes(q))) return false;
    if(q2 && !(p.name.toLowerCase().includes(q2) || p.desc.toLowerCase().includes(q2) || p.brand.toLowerCase().includes(q2))) return false;
    return true;
  });
  if(sortBy === 'price-asc') list.sort((a,b)=>a.price-b.price);
  if(sortBy === 'price-desc') list.sort((a,b)=>b.price-a.price);
  return list;
}
function renderProducts(){
  const list = getFilteredProducts();
  const grid = document.getElementById('productGrid');
  grid.innerHTML = '';
  document.getElementById('resultsInfo').textContent = `${list.length} s·∫£n ph·∫©m`;
  if(list.length === 0){ grid.innerHTML = `<div style="grid-column:1/-1;padding:24px;text-align:center;color:var(--muted)">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m.</div>`; return; }
  list.forEach(p=>{
    const div = document.createElement('article');
    div.className = 'card';
    div.innerHTML = `
      <img src="${p.image}" alt="${p.name}">
      <div class="meta">
        <h4>${p.name}</h4>
        <p class="muted">${p.brand}</p>
        <p class="muted" style="margin-top:8px">${p.desc}</p>
        <div class="foot">
          <div class="price">${formatMoney(p.price)}</div>
          <div style="display:flex;gap:8px">
            <button class="btn ghost" onclick="openDetail(${p.id})">Xem chi ti·∫øt</button>
            <button class="btn primary" onclick="addToCart(${p.id})">Th√™m</button>
          </div>
        </div>
      </div>`;
    grid.appendChild(div);
  });
}

/* --------------- FILTER ACTIONS --------------- */
document.getElementById('globalSearch').addEventListener('input', ()=>{ applyFilters(); });
document.getElementById('filterSearch').addEventListener('input', ()=>{ applyFilters(); });
document.getElementById('sortBy').addEventListener('change', (e)=>{ sortBy = e.target.value; applyFilters(); });

function applyFilters(){
  // read price radio
  const price = document.querySelector('input[name="price"]:checked');
  filters.price = price ? price.value : 'all';
  renderProducts();
}
function resetFilters(){
  filters = { brand:'all', price:'all', q:'' };
  document.getElementById('globalSearch').value = '';
  document.getElementById('filterSearch').value = '';
  document.querySelectorAll('input[name="price"]').forEach(r=>r.checked = r.value==='all');
  document.querySelectorAll('.brand-btn').forEach(b=>b.classList.remove('active'));
  renderProducts();
}

/* ---------------- CART FUNCTIONS ---------------- */
function updateCartUI(){
  const listEl = document.getElementById('cartList');
  listEl.innerHTML = '';
  let total = 0;
  if(cart.length === 0){
    listEl.innerHTML = '<div style="color:var(--muted);padding:12px">Gi·ªè h√†ng tr·ªëng</div>';
  } else {
    cart.forEach((item, idx)=>{
      total += item.price * (item.qty||1);
      const li = document.createElement('li');
      li.className = 'cart-item';
      li.innerHTML = `
        <img src="${item.image}" alt="${item.name}">
        <div class="info">
          <h4>${item.name}</h4>
          <div class="meta">${item.brand}</div>
          <div class="qty-controls">
            <button onclick="changeQty(${idx}, -1)">‚àí</button>
            <div style="padding:6px 10px;border-radius:6px;background:#f3f3f3;margin-left:6px;margin-right:6px">${item.qty||1}</div>
            <button onclick="changeQty(${idx}, 1)">+</button>
          </div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:900">${(item.price * (item.qty||1)).toLocaleString('vi-VN')} ƒë</div>
          <div style="margin-top:8px"><button style="border:0;background:transparent;color:#d33;cursor:pointer" onclick="removeFromCart(${idx})">x</button></div>
        </div>`;
      listEl.appendChild(li);
    });
  }
  document.getElementById('cartTotal').textContent = formatMoney(total);
  document.getElementById('miniCount').textContent = cart.reduce((s,i)=>s + (i.qty||1),0);
  saveCart();
}
function addToCart(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  const idx = cart.findIndex(i=>i.id===p.id);
  if(idx >= 0) cart[idx].qty = (cart[idx].qty||1) + 1;
  else cart.push({...p, qty:1});
  updateCartUI();
  openCart();
}
function changeQty(i, delta){
  if(!cart[i]) return;
  cart[i].qty = (cart[i].qty||1) + delta;
  if(cart[i].qty <= 0) cart.splice(i,1);
  updateCartUI();
}
function removeFromCart(i){ cart.splice(i,1); updateCartUI(); }
function clearCart(){ if(confirm('X√≥a to√†n b·ªô gi·ªè h√†ng?')){ cart=[]; updateCartUI(); } }

/* ---------------- CART SIDEBAR ---------------- */
const cartSidebar = document.getElementById('cartSidebar');
function toggleCart(force){
  const open = cartSidebar.classList.contains('open');
  // if force true -> open, if force false -> close
  if(force === true) cartSidebar.classList.add('open');
  else if(force === false) cartSidebar.classList.remove('open');
  else cartSidebar.classList.toggle('open');
  // reflect aria-hidden
  cartSidebar.setAttribute('aria-hidden', !cartSidebar.classList.contains('open'));
}

/* --------------- DETAIL MODAL --------------- */
const detailModal = document.getElementById('detailModal');
function openDetail(id){
  const p = products.find(x=>x.id===id);
  if(!p) return;
  document.getElementById('detailMain').src = p.gallery && p.gallery[0] ? p.gallery[0] : p.image;
  document.getElementById('thumbs').innerHTML = '';
  (p.gallery || [p.image]).forEach(src=>{
    const im = document.createElement('img'); im.src = src; im.style.width='64px';im.style.height='64px';im.style.objectFit='cover';im.style.borderRadius='8px';
    im.onclick = ()=> document.getElementById('detailMain').src = src;
    document.getElementById('thumbs').appendChild(im);
  });
  document.getElementById('detailTitle').textContent = p.name;
  document.getElementById('detailBrand').textContent = p.brand;
  document.getElementById('detailPrice').textContent = formatMoney(p.price);
  document.getElementById('detailDesc').textContent = p.desc;
  document.getElementById('detailFeaturesText').textContent = (p.features||[]).slice(0,2).join(' ‚Ä¢ ') + (p.features.length>2 ? ' ...' : '');
  document.getElementById('detailMore').textContent = 'Xem th√™m';
  // set add button
  document.getElementById('detailAddBtn').onclick = ()=>{ addToCart(p.id); closeDetail(); };
  detailModal.classList.add('open');
}
function closeDetail(){ detailModal.classList.remove('open'); }

/* -------------- PAYMENT TAB (cart) ------------- */
function switchPayTab(el){
  document.querySelectorAll('.pm-tab').forEach(t=>t.classList.remove('active'));
  el.classList.add('active');
  const m = el.dataset.method;
  document.querySelectorAll('.pm-box').forEach(b=>b.classList.remove('active'));
  document.getElementById('pm-'+m).classList.add('active');
}

/* -------------- CHECKOUT FLOW -------------- */
function openCheckoutFromCart(){
  if(cart.length === 0){ alert('Gi·ªè h√†ng tr·ªëng'); return; }
  // create summary
  let html = '<ul style="padding-left:18px">';
  let total = 0;
  cart.forEach(it=>{ html += `<li>${it.name} √ó ${it.qty||1} ‚Äî ${(it.price*(it.qty||1)).toLocaleString('vi-VN')} ƒë</li>`; total += it.price*(it.qty||1); });
  html += `</ul><div style="margin-top:10px"><strong>T·ªïng: ${total.toLocaleString('vi-VN')} ƒë</strong></div>`;
  document.getElementById('checkoutSummary').innerHTML = html;
  document.getElementById('checkoutEmail').value = document.getElementById('invoiceEmail').value || '';
  document.getElementById('checkoutModal').classList.add('open');
}
function closeCheckout(){ document.getElementById('checkoutModal').classList.remove('open'); }

/* --------------- PROCESS CHECKOUT & INVOICE -------------- */
/* EmailJS config (t√πy ch·ªçn): thay khi b·∫°n c√≥ account */
const EMAILJS_SERVICE = 'YOUR_SERVICE_ID';
const EMAILJS_TEMPLATE = 'YOUR_TEMPLATE_ID';
const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
if(window.emailjs && EMAILJS_PUBLIC_KEY && EMAILJS_PUBLIC_KEY !== 'YOUR_PUBLIC_KEY'){
  try{ emailjs.init(EMAILJS_PUBLIC_KEY); }catch(e){ console.warn(e); }
}

async function processCheckout(){
  const email = document.getElementById('checkoutEmail').value.trim();
  if(!email){ alert('Vui l√≤ng nh·∫≠p email ƒë·ªÉ nh·∫≠n h√≥a ƒë∆°n'); return; }
  // chosen method
  const method = document.querySelector('input[name="checkoutPay"]:checked').value;
  // create invoice and send
  await createInvoiceAndSend(email, method);
  alert('ƒê√£ t·∫°o h√≥a ƒë∆°n. (Demo)'); // In real app you'd also record order in backend
  cart = []; updateCartUI(); closeCheckout(); toggleCart(false);
}

/* user confirms payment from cart tabs */
async function confirmPaid(method){
  const email = document.getElementById('invoiceEmail').value.trim() || prompt('Nh·∫≠p email ƒë·ªÉ nh·∫≠n h√≥a ƒë∆°n:');
  if(!email){ alert('C·∫ßn email ƒë·ªÉ g·ª≠i h√≥a ƒë∆°n.'); return; }
  await createInvoiceAndSend(email, method);
  alert('Ghi nh·∫≠n thanh to√°n (demo). H√≥a ƒë∆°n ƒë√£ g·ª≠i/t·∫£i v·ªÅ.');
  cart = []; updateCartUI(); toggleCart(false);
}

/* create invoice DOM, download PDF, optionally send via EmailJS */
async function createInvoiceAndSend(email, method = 'unknown'){
  if(cart.length === 0){ alert('Gi·ªè h√†ng r·ªóng'); return; }
  const now = new Date();
  const dateStr = now.toLocaleString('vi-VN');
  let total = cart.reduce((s,i)=>s + i.price*(i.qty||1), 0);
  const invoice = document.createElement('div');
  invoice.className = 'invoice';
  invoice.innerHTML = `
    <div class="inv-head">
      <div>
        <div class="inv-title">Tu·∫•n ƒê·ªì Hi·ªáu</div>
        <div style="color:#666">H√≥a ƒë∆°n b√°n l·∫ª</div>
      </div>
      <div style="text-align:right">
        <div style="color:#666">Ng√†y: ${dateStr}</div>
        <div style="color:#666">H√¨nh th·ª©c: ${method.toUpperCase()}</div>
      </div>
    </div>
    <table class="inv-table">
      <thead><tr><th>STT</th><th>S·∫£n ph·∫©m</th><th>ƒê∆°n gi√°</th><th>S·ªë l∆∞·ª£ng</th><th>Th√†nh ti·ªÅn</th></tr></thead>
      <tbody>
        ${cart.map((it,idx)=>`<tr><td>${idx+1}</td><td>${it.name}</td><td>${it.price.toLocaleString('vi-VN')} ƒë</td><td>${it.qty||1}</td><td>${(it.price*(it.qty||1)).toLocaleString('vi-VN')} ƒë</td></tr>`).join('')}
      </tbody>
    </table>
    <div style="margin-top:12px;text-align:right;font-weight:700">T·ªîNG: ${total.toLocaleString('vi-VN')} ƒë</div>
    <div style="margin-top:12px;color:#666">H√≥a ƒë∆°n ƒë∆∞·ª£c g·ª≠i t·ªõi: ${email}</div>
    <div style="margin-top:16px;color:#777">C·∫£m ∆°n qu√Ω kh√°ch ƒë√£ mua s·∫Øm t·∫°i Tu·∫•n ƒê·ªì Hi·ªáu.</div>
  `;
  const container = document.getElementById('invoiceContainer');
  container.innerHTML = '';
  container.appendChild(invoice);

  // Wait for fonts
  if(document.fonts && document.fonts.ready) await document.fonts.ready;

  // PDF options
  const opt = {
    margin: 10,
    filename: `hoa-don-${Date.now()}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS: true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };

  try {
    // Download PDF to user
    await html2pdf().set(opt).from(invoice).save();

    // Optionally send email via EmailJS (if configured)
    if(window.emailjs && EMAILJS_SERVICE !== 'YOUR_SERVICE_ID' && EMAILJS_TEMPLATE !== 'YOUR_TEMPLATE_ID'){
      const params = { to_email: email, invoice_html: invoice.innerHTML, invoice_total: total.toLocaleString('vi-VN') + ' ƒë', invoice_date: dateStr };
      await emailjs.send(EMAILJS_SERVICE, EMAILJS_TEMPLATE, params);
    }
  } catch(e){
    console.error('Invoice error', e);
    alert('L·ªói khi t·∫°o/g·ª≠i h√≥a ƒë∆°n. Ki·ªÉm tra console.');
  } finally {
    container.innerHTML = '';
  }
}

/* utility download via button */
function downloadInvoice(){
  const email = document.getElementById('invoiceEmail').value.trim();
  if(!email){ alert('Nh·∫≠p email ƒë·ªÉ nh·∫≠n h√≥a ƒë∆°n (s·∫Ω ghi trong h√≥a ƒë∆°n)'); return; }
  createInvoiceAndSend(email, 'download-only');
}

/* init */
function init(){
  renderProducts();
  updateCartUI();
  updateBrandButtons();
}
init();

/* extra helpers */
function scrollToProducts(){ document.getElementById('productGrid').scrollIntoView({behavior:'smooth'}); }
function scrollToContact(){ document.getElementById('contact').scrollIntoView({behavior:'smooth'}); }

/* expose some functions to inline handlers */
window.addToCart = addToCart;
window.openDetail = openDetail;
window.closeDetail = closeDetail;
window.toggleCart = toggleCart;
window.clearCart = clearCart;
window.switchPayTab = (el) => switchPayTab(el);
window.confirmPaid = confirmPaid;
window.downloadInvoice = downloadInvoice;
window.openCheckoutFromCart = openCheckoutFromCart;
window.processCheckout = processCheckout;
window.applyFilters = applyFilters;
window.resetFilters = resetFilters;
window.selectBrand = function(b){ filters.brand = b; updateBrandButtons(); applyFilters(); };

</script>
</body>
</html>
